AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Messages between services using API Gateway, Lambda, SQS, EventBridge, SNS, DynamoDB and S3 with monitoring via CloudWatch and X-Ray

Parameters:
  MessageQueueName:
    Type: String
    Default: sqs-1
  EventBridgeOneName:
    Type: String
    Default: rule-1
  QueueTwoName:
    Type: String
    Default: sqs-2
  QueueTwoDLQName:
    Type: String
    Default: sqs-2-dlq
  EventBridgeTwoName:
    Type: String
    Default: rule-2
  SNSTopicName:
    Type: String
    Default: sns-target-topic
  MessagesTableName:
    Type: String
    Default: messages-table
  S3BucketName:
    Type: String
    Default: target-bucket

Globals:
  Function:
    Timeout: 10
    Runtime: python3.12
    Layers:
      - !Ref CommonDependenciesLayer
  Api:
    TracingEnabled: true

Resources:

  # -----------------------------------
  # --- Layer with dependencies ---
  CommonDependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: dependencies/
      CompatibleRuntimes:
        - python3.12

  # --- API Gateway with CORS ---
  MessageApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      TracingEnabled: true
      Cors:
        AllowMethods: "'OPTIONS,POST,GET'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  # ---------|| WebSocket API Gateway ||---------
  MessageWebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: MessageWebSocketApi
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"


  # ---------|| Lambdas for WebSocket connections management ||---------
  WebSocketConnectLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/websocket/connect
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable



  # ---------|| Lambda para $connect (nueva conexión) ||---------
  WebSocketDisconnectLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/websocket/disconnect
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable



  # ---------|| WebSocket Integrations and Routes ||---------
  WebSocketConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref MessageWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectLambda.Arn}/invocations"
      IntegrationMethod: POST



  # ---------|| WebSocket Disconnect Integration ||---------
  WebSocketDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref MessageWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectLambda.Arn}/invocations"



  # ---------|| WebSocket Routes ||---------
  WebSocketConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MessageWebSocketApi
      RouteKey: $connect
      Target: !Sub "integrations/${WebSocketConnectIntegration.IntegrationId}"



  # ---------|| WebSocket Disconnect Route ||---------
  WebSocketDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MessageWebSocketApi
      RouteKey: $disconnect
      Target: !Sub "integrations/${WebSocketDisconnectIntegration.IntegrationId}"

  # ---------|| Permissions for API Gateway to invoke Lambdas ||---------
  PermissionForApiToInvokeConnectLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketConnectLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MessageWebSocketApi}/*/$connect"



  # ---------|| Permissions for API Gateway to invoke Lambdas ||---------
  PermissionForApiToInvokeDisconnectLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketDisconnectLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MessageWebSocketApi}/*/$disconnect"



  # ---------|| Lambda for WebSocket $default route ||---------
  WebSocketDefaultLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/websocket/default
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable



  # ---------|| Integración WebSocket $default ||---------
  WebSocketDefaultIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref MessageWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDefaultLambda.Arn}/invocations"



  # ---------|| Ruta $default ||---------
  WebSocketDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MessageWebSocketApi
      RouteKey: $default
      Target: !Sub "integrations/${WebSocketDefaultIntegration.IntegrationId}"



  # ---------|| Permissions for API Gateway to invoke Lambdas ||---------
  PermissionForApiToInvokeDefaultLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketDefaultLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MessageWebSocketApi}/*/$default"



  # ---------|| Deployment for WebSocket API ||---------
  MessageWebSocketDeployment:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn:
      - WebSocketConnectRoute
      - WebSocketDisconnectRoute
      - WebSocketDefaultRoute 
    Properties:
      ApiId: !Ref MessageWebSocketApi
  


  # ---------|| Stage for WebSocket API ||---------
  MessageWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: Prod
      DeploymentId: !Ref MessageWebSocketDeployment
      ApiId: !Ref MessageWebSocketApi
      AutoDeploy: true

  # --- SQS Queue (API -> SQS1) ---
  MessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref MessageQueueName

  # --- Lambda messgae router queue: API -> SQS ---
  ApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/message_router_queue/
      Handler: app.lambda_handler
      Tracing: Active
      Environment:
        Variables:
          QUEUE_URL: !Ref MessageQueue
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt MessageQueue.QueueName
        - AWSXRayDaemonWriteAccess
      Events:
        ApiPost:
          Type: Api
          Properties:
            Path: /send
            Method: post
            RestApiId: !Ref MessageApi

  # ---------|| Lambda Function for Dashboard Metrics ||---------
  DashboardLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/lambda_dashboard/
      Handler: app.handler
      Runtime: nodejs20.x
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          SNS_TOPIC_NAME: !Ref SNSTopicName
          SQS_QUEUE_NAME: !Ref MessageQueueName
          LAMBDA_FUNCTION_NAME: !Sub "${AWS::StackName}-${ApiFunction}"
      Policies:
        - CloudWatchReadOnlyAccess
        - AWSXRayDaemonWriteAccess
      Events:
        MetricsApiGet:
          Type: Api
          Properties:
            Path: /dashboard
            Method: get
            RestApiId: !Ref MessageApi

  # --- Lambda Dispatcher: SQS1 -> EventBridge ---
  LambdaDispatcher:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/lambda_dispatcher/
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          EVENT_BUS_NAME: default
      Policies:
        - SQSPollerPolicy:
            QueueName: !GetAtt MessageQueue.QueueName
        - Statement:
            Effect: Allow
            Action:
              - events:PutEvents
            Resource: !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
        - AWSXRayDaemonWriteAccess
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt MessageQueue.Arn
            BatchSize: 1

  # --- EventBridge Rule 1: messages from LambdaDispatcher -> EBToSQS2Function ---
  MessageReceivedRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Ref EventBridgeOneName
      Description: "Rule for capturing events emitted by LambdaDispatcher"
      EventPattern:
        source:
          - my.app.messages
        detail-type:
          - MessageReceived
      Targets:
        - Arn: !GetAtt EBToSQS2Function.Arn
          Id: "EBToSQS2LambdaTarget"

  # Permission for EventBridge to invoke EBToSQS2Function
  PermissionForEventsInvokeEBToSQS2:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref EBToSQS2Function
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MessageReceivedRule.Arn

  # --- Lambda: EventBridge Rule 1 -> SQS 2 ---
  EBToSQS2Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/eb_to_sqs2/
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          QUEUE_URL: !Ref QueueTwo
      Policies:
        - Statement:
            Effect: Allow
            Action: sqs:SendMessage
            Resource: !GetAtt QueueTwo.Arn
        - AWSXRayDaemonWriteAccess

  # -- SQS 2 and DLQ ---
  QueueTwoDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref QueueTwoDLQName

  QueueTwo:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref QueueTwoName
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt QueueTwoDLQ.Arn
        maxReceiveCount: 5

  # --- IAM Role para Step Functions (ejecución) ---
  StepFunctionsExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: StepFunctionsLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  # Acciones recomendadas por la doc + extras útiles
                  - logs:CreateLogGroup
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                  - logs:PutDestination
                  - logs:PutDestinationPolicy
                  - logs:AssociateKmsKey
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/vendedlogs/states/${AWS::StackName}-MessageProcessingStateMachine:*"
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: "*"
        - PolicyName: StepFunctionsExecutionBase
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'


  # LogGroup para los logs de Step Functions (CloudWatch)
  MessageProcessingStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-MessageProcessingStateMachine"
      RetentionInDays: 14

  # State Machine (CloudFormation nativa) - soporta LoggingConfiguration
  MessageProcessingStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      RoleArn: !GetAtt StepFunctionsExecutionRole.Arn
      TracingConfiguration:
        Enabled: true
      LoggingConfiguration:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt MessageProcessingStateMachineLogGroup.Arn
      DefinitionString: |
        {
          "Comment": "Minimal state machine for pipeline preserving input",
          "StartAt": "PassState",
          "States": {
            "PassState": {
              "Type": "Pass",
              "Result": {"status":"ok"},
              "ResultPath": "$.status",
              "End": true
            }
          }
        }


  # --- Lambda: SQS 2 -> Step Functions (poller) ---
  SQS2ToStepFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/sqs2_to_stepfn/
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          QUEUE_URL: !Ref QueueTwo
          STATE_MACHINE_ARN: !Ref MessageProcessingStateMachine
      Policies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole
        - AWSXRayDaemonWriteAccess 
        - Statement:
            - Effect: Allow
              Action: states:StartExecution
              Resource: !Ref MessageProcessingStateMachine
      Events:
        FromSQS2:
          Type: SQS
          Properties:
            Queue: !GetAtt QueueTwo.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 0

  # --- EventBridge: Rule 2 -> SNS (captura ejecuciones SFN) ---
  StepFnOutputsRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Ref EventBridgeTwoName
      Description: "Captures Step Functions status changes (SUCCEEDED/FAILED) and sends them to SNS"
      EventPattern:
        source:
          - aws.states
        detail-type:
          - Step Functions Execution Status Change
        detail:
          stateMachineArn:
            - !Ref MessageProcessingStateMachine
          status:
            - SUCCEEDED
            - FAILED
      Targets:
        - Arn: !Ref MySNSTopic
          Id: "SnsTargetForStepFnOutputs"

  # Policy that allows EventBridge to publish in SNS
  EventBridgeToSNSPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref MySNSTopic
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowEventBridgeToPublish
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref MySNSTopic

  # --- SNS Topic ---
  MySNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref SNSTopicName
      TracingConfig: 'Active'

  # --- Email SNS Topic ---
  EmailTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: Email
      TracingConfig: 'Active'

  # Permission for SNS to invoke DynamoLambda
  PermissionForSNSInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DynamoLambda
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref MySNSTopic

  # SNS subscription to Lambda
  DynamoLambdaSubscription:
    Type: AWS::SNS::Subscription
    DependsOn: PermissionForSNSInvokeLambda
    Properties:
      Protocol: lambda
      Endpoint: !GetAtt DynamoLambda.Arn
      TopicArn: !Ref MySNSTopic

  # --- Lambda Dynamo: SNS -> DynamoDB ---
  DynamoLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/lambda_dynamo/
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Environment:
        Variables:
          TABLE_NAME: !Ref MessagesTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - AWSXRayDaemonWriteAccess

  # --- DynamoDB ---
  MessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref MessagesTableName
      AttributeDefinitions:
        - AttributeName: MessageId
          AttributeType: S
      KeySchema:
        - AttributeName: MessageId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  # --- Contacts DynamoDB Table ---
  ContactsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ContactsTable
      AttributeDefinitions:
        - AttributeName: contactId
          AttributeType: S
      KeySchema:
        - AttributeName: contactId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  
  ConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ConnectionsTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: connectionId
          AttributeType: S
      KeySchema:
        - AttributeName: connectionId
          KeyType: HASH

  # --- Lambda DDB to S3: DynamoDB -> S3 ---
  DdbToS3Function:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-DdbToS3Handler'
      Handler: app.lambda_handler
      Tracing: Active
      CodeUri: backend/src/handlers/lambda_ddb_to_s3/
      Timeout: 30
      Environment:
        Variables:
          S3_BUCKET: !Ref TargetBucket
      Events:
        DdbStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt MessagesTable.StreamArn
            BatchSize: 1
            StartingPosition: LATEST
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MessagesTable
        - S3WritePolicy:
            BucketName: !Ref TargetBucket
        - AWSXRayDaemonWriteAccess
  
  # --- S3 Bucket ---
  TargetBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3EventsTopicPolicy
    Properties:
      NotificationConfiguration:
        TopicConfigurations:
          - Event: "s3:ObjectCreated:*"
            Topic: !Ref S3EventsTopic
        EventBridgeConfiguration:
          EventBridgeEnabled: true



  # ---------|| SNS Topic for S3 Events ||---------
  S3EventsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${AWS::StackName}-S3Events"

  # --- Lambda que expone métricas ---
  MetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/lambda_metrics
      Handler: app.lambda_handler
      Runtime: python3.12
      Tracing: Active
      Policies:
        - CloudWatchReadOnlyAccess
        - AWSXRayDaemonWriteAccess
      Events:
        MetricsApiGet:
          Type: Api
          Properties:
            Path: /metrics
            Method: get
            RestApiId: !Ref MessageApi


  
# ---------|| SNS Topic Policy for S3 to publish ||---------
  S3EventsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref S3EventsTopic
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: sns:Publish
            Resource: !Ref S3EventsTopic

  # ------------------------------------| Bedrock Text Agent |------------------------------------

  # ---------|| SNS Subscription from S3 to Lambda ||---------
  S3EventsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref S3EventsTopic
      Protocol: lambda
      Endpoint: !GetAtt S3ToBedrockFunction.Arn



  # ---------|| Permission for SNS to invoke Lambda ||---------
  PermissionForSNSToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref S3ToBedrockFunction
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref S3EventsTopic



# ---------|| Lambda to send S3 objects to Bedrock Text Agent ||---------
  S3ToBedrockFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/lambda_s3_to_bedrock/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 30
      Tracing: Active


      VpcConfig:
        SecurityGroupIds:
          - !ImportValue LambdaSecurityGroupId
        SubnetIds:
          - !ImportValue PrivateSubnet1Id
          - !ImportValue PrivateSubnet2Id


      Environment:
        Variables:
          VALKEY_HOST: !ImportValue ValkeyEndpointAddress
          VALKEY_PORT: !ImportValue ValkeyEndpointPort
          WEBSOCKET_ENDPOINT: !Sub "https://${MessageWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/Prod"
          CONNECTIONS_TABLE: !Ref ConnectionsTable


      Policies:
        # --- Leer objetos de S3 ---
        - Statement:
            Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Sub "${TargetBucket.Arn}/*"

        # --- Permiso para Amazon Nova (Converse API) ---
        - Statement:
            Effect: Allow
            Action:
              - bedrock:Converse
              - bedrock:InvokeModel
            Resource: "*"

        # --- X-Ray ---
        - AWSXRayDaemonWriteAccess
        
        # --- Permiso para leer conexiones WebSocket de DynamoDB ---
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable
        
        # --- Permiso para enviar mensajes a WebSocket API Gateway ---
        - Statement:
            Effect: Allow
            Action:
              - execute-api:ManageConnections
            Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MessageWebSocketApi}/*/*"






  # ------------------------------------| Bedrock Image Generation |------------------------------------

  # ---------|| S3 Bucket for generated images ||---------
  GeneratedImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      # Removed explicit BucketName to avoid conflicts - CloudFormation will generate unique name
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled



  # ---------|| Lambda to send S3 objects to Bedrock (Image generation) ||---------
  S3ToBedrockImageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-S3ToBedrockImageHandler'
      CodeUri: backend/src/handlers/lambda_s3_to_bedrock_image/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 120
      Tracing: Active
      VpcConfig:
        SecurityGroupIds:
          - !ImportValue LambdaSecurityGroupId
        SubnetIds:
          - !ImportValue PrivateSubnet1Id
          - !ImportValue PrivateSubnet2Id
      Environment:
        Variables:
          MODEL_ID: "amazon.nova-canvas-v1:0"
          OUTPUT_BUCKET: !Ref GeneratedImagesBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Sub "${TargetBucket.Arn}/*"
        - S3WritePolicy:
            BucketName: !Ref GeneratedImagesBucket 
        - Statement:
            Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource: "*"
        - AWSXRayDaemonWriteAccess



  # ---------|| Permission for SNS to invoke Image Lambda ||---------
  PermissionForSNSToInvokeImageLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref S3ToBedrockImageFunction
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref S3EventsTopic



  # ---------|| SNS Subscription from S3 to Bedrock Image Lambda ||---------
  S3ImageEventsSubscription:
    Type: AWS::SNS::Subscription
    DependsOn: PermissionForSNSToInvokeImageLambda
    Properties:
      TopicArn: !Ref S3EventsTopic
      Protocol: lambda
      Endpoint: !GetAtt S3ToBedrockImageFunction.Arn


  # --- Lambda SMS Validation and Send ---
  SMSValidationSendFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/src/handlers/sms_validation_send/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          CONTACTS_TABLE_NAME: !Ref ContactsTable
          EMAIL_SNS_TOPIC_ARN: !Ref EmailTopic
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - dynamodb:*
            Resource: "*"
        - Statement:
            Effect: Allow
            Action:
              - sns:*
            Resource: !Ref EmailTopic
        - AWSXRayDaemonWriteAccess
      Events:
        ContactsApiPost:
          Type: Api
          Properties:
            Path: /sms/contacts
            Method: post
            RestApiId: !Ref MessageApi
        ContactsApiOptions:
          Type: Api
          Properties:
            Path: /sms/contacts
            Method: options
            RestApiId: !Ref MessageApi

  # X-Ray resource policy para SNS
  XRayResourcePolicyForSNS:
    Type: AWS::XRay::ResourcePolicy
    Properties:
      PolicyName: !Sub "AllowSNSXRayPutTraceSegments-${AWS::StackName}"
      PolicyDocument: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "SNSAccess",
              "Effect": "Allow",
              "Principal": { "Service": "sns.amazonaws.com" },
              "Action": [
                "xray:PutTraceSegments",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets"
              ],
              "Resource": "*",
              "Condition": {
                "StringEquals": { "aws:SourceAccount": "${AWS::AccountId}" },
                "StringLike": { "aws:SourceArn": "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:*" }
              }
            }
          ]
        }

  # --- Dashboard ---
  CloudWatchDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AWS::StackName}-ServiceOverview"
      DashboardBody:
        !Sub
          - |
            {
                "widgets": [
                    {
                        "type": "metric",
                        "x": 6,
                        "y": 0,
                        "width": 6,
                        "height": 6,
                        "properties": {
                            "title": "SNS Messages Published",
                            "view": "gauge",
                            "region": "${Region}",
                            "period": 300,
                            "metrics": [
                                [ "AWS/SNS", "NumberOfMessagesPublished", "TopicName", "${MySNSTopicName}", { "stat": "Sum" } ]
                            ],
                            "yAxis": {
                                "left": {
                                    "min": 0,
                                    "max": 1000
                                }
                            }
                        }
                    },
                    {
                        "type": "metric",
                        "x": 0,
                        "y": 0,
                        "width": 6,
                        "height": 6,
                        "properties": {
                            "title": "S3 NumberOfObjects (TargetBucket)",
                            "view": "gauge",
                            "region": "${Region}",
                            "period": 86400,
                            "metrics": [
                                [ "AWS/S3", "NumberOfObjects", "BucketName", "${TargetBucket}", "StorageType", "AllStorageTypes", { "stat": "Average" } ]
                            ],
                            "yAxis": {
                                "left": {
                                    "min": 0,
                                    "max": 1000000
                                }
                            }
                        }
                    },
                    {
                        "type": "metric",
                        "x": 12,
                        "y": 6,
                        "width": 12,
                        "height": 6,
                        "properties": {
                            "title": "SQS Queue: visible / in-flight / sent",
                            "view": "timeSeries",
                            "region": "${Region}",
                            "period": 60,
                            "metrics": [
                                [ "AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${MessageQueue}", { "stat": "Average" } ],
                                [ "AWS/SQS", "ApproximateNumberOfMessagesNotVisible", "QueueName", "${MessageQueue}", { "stat": "Average" } ],
                                [ "AWS/SQS", "NumberOfMessagesSent", "QueueName", "${MessageQueue}", { "stat": "Sum" } ],
                                [ "AWS/SQS", "NumberOfMessagesReceived", "QueueName", "${MessageQueue}", { "stat": "Sum" } ]
                            ]
                        }
                    },
                    {
                        "type": "metric",
                        "x": 12,
                        "y": 0,
                        "width": 12,
                        "height": 6,
                        "properties": {
                            "title": "DynamoDB (MessagesTable): Consumed R/W & Throttles",
                            "view": "timeSeries",
                            "region": "${Region}",
                            "period": 60,
                            "metrics": [
                                [ "AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${MessagesTable}", { "stat": "Sum", "label": "read" } ],
                                [ "AWS/DynamoDB", "ConsumedWriteCapacityUnits", "TableName", "${MessagesTable}", { "stat": "Sum", "label": "write" } ],
                                [ "AWS/DynamoDB", "ThrottledRequests", "TableName", "${MessagesTable}", { "stat": "Sum", "label": "throttles" } ]
                            ]
                        }
                    },
                    {
                        "type": "metric",
                        "x": 0,
                        "y": 12,
                        "width": 12,
                        "height": 6,
                        "properties": {
                            "title": "Lambda Errors",
                            "view": "table",
                            "region": "${Region}",
                            "period": 60,
                            "metrics": [
                                [ "AWS/Lambda", "Errors", "FunctionName", "${ApiFunction}", { "stat": "Sum" } ],
                                [ "AWS/Lambda", "Errors", "FunctionName", "${LambdaDispatcher}", { "stat": "Sum" } ],
                                [ "AWS/Lambda", "Errors", "FunctionName", "${DynamoLambda}", { "stat": "Sum" } ],
                                [ "AWS/Lambda", "Errors", "FunctionName", "${DdbToS3Function}", { "stat": "Sum" } ]
                            ]
                        }
                    },
                    {
                        "type": "metric",
                        "x": 6,
                        "y": 6,
                        "width": 6,
                        "height": 6,
                        "properties": {
                            "title": "Lambda Concurrency",
                            "view": "gauge",
                            "region": "${Region}",
                            "period": 60,
                            "metrics": [
                                [ "AWS/Lambda", "ConcurrentExecutions", "FunctionName", "${ApiFunction}", { "stat": "Average" } ]
                            ],
                            "yAxis": {
                                "left": {
                                    "min": 0,
                                    "max": 100
                                }
                            }
                        }
                    },
                    {
                        "type": "metric",
                        "x": 0,
                        "y": 6,
                        "width": 6,
                        "height": 6,
                        "properties": {
                            "title": "Invocation distribution",
                            "view": "pie",
                            "region": "${Region}",
                            "period": 300,
                            "metrics": [
                                [ "AWS/Lambda", "Invocations", "FunctionName", "${ApiFunction}", { "stat": "Sum", "label": "api_router" } ],
                                [ "AWS/Lambda", "Invocations", "FunctionName", "${LambdaDispatcher}", { "stat": "Sum", "label": "dispatcher" } ],
                                [ "AWS/Lambda", "Invocations", "FunctionName", "${DynamoLambda}", { "stat": "Sum", "label": "dynamo_handler" } ],
                                [ "AWS/Lambda", "Invocations", "FunctionName", "${DdbToS3Function}", { "stat": "Sum", "label": "ddb_to_s3" } ]
                            ]
                        }
                    },
                    {
                        "type": "metric",
                        "x": 12,
                        "y": 12,
                        "width": 12,
                        "height": 6,
                        "properties": {
                            "title": "Lambda Errors & Duration",
                            "view": "timeSeries",
                            "region": "${Region}",
                            "period": 60,
                            "metrics": [
                                [ "AWS/Lambda", "Errors", "FunctionName", "${ApiFunction}", { "stat": "Sum", "label": "errors_api" } ],
                                [ "AWS/Lambda", "Duration", "FunctionName", "${ApiFunction}", { "stat": "Average", "label": "dur_api" } ]
                            ]
                        }
                    }
                ]
            }
          - {
              StackName: !Ref "AWS::StackName",
              Region: !Ref "AWS::Region",
              MessageApi: !Ref MessageApi,
              ApiFunction: !Ref ApiFunction,
              LambdaDispatcher: !Ref LambdaDispatcher,
              DynamoLambda: !Ref DynamoLambda,
              DdbToS3Function: !Ref DdbToS3Function,
              MessageQueue: !GetAtt MessageQueue.QueueName,
              MessagesTable: !Ref MessagesTable,
              MySNSTopicName: !Select [5, !Split [":", !Ref MySNSTopic]],
              TargetBucket: !Ref TargetBucket
            }


Outputs:
  ApiUrl:
    Description: "API Gateway endpoint"
    Value: !Sub "https://${MessageApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/send"
  SNSTopicArn:
    Description: "SNS Topic ARN"
    Value: !Ref MySNSTopic
  DynamoDBTableName:
    Description: "DynamoDB Table Name"
    Value: !Ref MessagesTable
  BucketName:
    Description: "Name of the S3 bucket"
    Value: !Ref TargetBucket
  MetricsApiUrl:
    Description: "API Gateway endpoint para métricas"
    Value: !Sub "https://${MessageApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/metrics"
  ContactsApiUrl:
    Description: "API Gateway endpoint para contactos"
    Value: !Sub "https://${MessageApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/contacts"